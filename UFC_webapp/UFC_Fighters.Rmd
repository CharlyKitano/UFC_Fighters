---
title: "UFC Fighters"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    scroll: true
    vertical_layout: fill
    source_code: embed
runtime: shiny
resource_files:
- Final_data.csv
- Final_data.csv
- Final_data.csv
- Final_data_raw.csv
---



```{r setup, echo=FALSE}
library(shiny)
library(shinydashboard)
library(DT)
# <<<<<<< HEAD
# <<<<<<< HEAD
data <- read.csv("Final_data.csv") 
data_raw <- read.csv("Final_data_raw.csv") 
country = unique(data$Country)
fightstyle = unique(data$Fighting.style)
weightclass = unique(data$Weight.Class)

country = unique(data$Country)
country<-c(country,"No country")


# UI code 
# =======
# =======
# >>>>>>> 847fe8959298a23bc279fb1be39dcd49f99aae35

# Load data
# data <- read.csv("C:/Users/HP/Documents/EMA cours/projet visu/Final_data.csv")

# UI code
# >>>>>>> 847fe8959298a23bc279fb1be39dcd49f99aae35
ui <- fluidPage(
  dashboardPage(
    dashboardHeader(title = "UFC"),
    dashboardSidebar(
      sidebarMenu(
        menuItem("Présentation", tabName = "presentation"),
        menuItem("Description des données", tabName = "description_des_donnees"),
        menuItem("General Info", tabName = "general_info"),
        menuItem("Comparison", tabName = "comparison")
        
      )
    ),
    dashboardBody(

      tabItems(


          tabName = "general_info",
          fluidRow(
              box(
                title = "Filters",
                status = "primary",
                solidHeader = TRUE,
                collapsible = TRUE,
                width = 12,
                fluidRow(
                  column(12, selectInput("country", "Country:",
                                        choices = country
                                        )),
                  column(12, selectInput("fighting_style", "Fighting Style:",
                                        choices = fightstyle,
                                        selected = "KICKBOXER")),
                  column(12, textInput("age", "Age:", placeholder = "Enter age")),
                  # column(12, selectInput("fighting_style", "Fighting Style:")),
                  
                  column(12, selectInput("weight_class", "Weight Class:",
                                        choices = weightclass)),
                  column(12, selectInput("gender", "Gender:",
                                        choices = c("Male", "Female")
                                       ),
                  column(6, textInput("height_from", "Height:", placeholder = "From")),
                  column(6, textInput("height_to",".", placeholder = "To")),
                  
                  )
                ),
                actionButton("get_results", "Get Results", class = "btn-primary")
              )
            ),
          fluidRow(
            column(12, DTOutput("placeholder_table"))
          )
        ),
        tabItem(
          tabName = "comparison",
          fluidRow(
            box(
              title = "Player Comparison",
              status = "warning",
              solidHeader = TRUE,
              collapsible = TRUE,
              fluidRow(
                column(6, textInput("player1", "Player 1:", placeholder = "Enter name")),
                column(6, textInput("player2", "Player 2:", placeholder = "Enter name"))
              ),
              actionButton("compare_players", "Compare Players", class = "btn-warning")
            ),
            box(
              title = "Player Info",
              status = "primary",
              solidHeader = TRUE,
              collapsible = TRUE,
              textInput("player_info", "Player Info:", placeholder = "Enter name"),
              actionButton("generate", "Generate Info")
            ),
            fluidRow(
              column(12, tableOutput("player_info_table"), align = "center")
            ),
            #think about adding a fluid row here to have them side by side or create uiOutput that has both of them 
            #think also of checking the column size
             fluidRow(
       uiOutput("player_charts_ui"),  
       uiOutput("player_values_ui")   
    )
           
          )
        )
      )
    )
  )
)


# Server code
server <- function(input, output, session) {
  generate_clicked <- reactiveVal(FALSE)
  output$placeholder_table <- renderDT({
    req(input$get_results)
    
    # if (!is.null(input$country) && !is.null(input$age) ) {
    #    # Based on the provided inputs, generate or filter the datatable
    # 
    #    filtered_data <- data[data["Place.of.Birth"] == input$country & data$Age == input$age,,drop=FALSE]
    #    print(filtered_data)
    # 
    # 
    # 
    # 
    # 
    #   return(datatable(filtered_data))  # Render the datatable with the filtered data
    # }
    
    filtered_data <- data_raw
    
    # Filter by country if provided
    if (!is.null(input$country) && input$country != "") {
      filtered_data <- filtered_data[filtered_data["Country"] == input$country, ,drop=FALSE]
    }
    
    # Filter by fighting style if provided
    if (!is.null(input$fighting_style) && input$fighting_style != "") {
      filtered_data <- filtered_data[filtered_data["Fighting.style"] == input$fighting_style, ,drop=FALSE]
    }
    
    #Filter by age if provided
    if (!is.null(input$age) && input$age != "") {
      filtered_data <- filtered_data[filtered_data$Age == as.numeric(input$age), ]
    }
    
    # Filter by weight class if provided
    if (!is.null(input$weight_class) && input$weight_class != "") {
      filtered_data <- filtered_data[filtered_data$Weight.Class == input$weight_class, ,drop=FALSE]
    }
    
    # Filter by gender if provided
    if (!is.null(input$gender) && input$gender != "") {
      if(input$gender == "Male"){ genderr = "man"}else if(input$gender == "Female"){genderr = "women"}
      filtered_data <- filtered_data[filtered_data$gender == genderr, ,drop=FALSE]
    }
    
    if (!is.null(input$height_from) && input$height_from != "") {
      filtered_data <- filtered_data[filtered_data$Height >= input$height_from, ,drop=FALSE]
    }
    
    if (!is.null(input$height_to) && input$height_to != "") {
      filtered_data <- filtered_data[filtered_data$Height <= input$height_to, ,drop=FALSE]
    }
    
    column_with_na <- "Name"  # Specify the column with potential NA values
    filtered_data <- filtered_data[complete.cases(filtered_data[, column_with_na]), ]

    return(datatable(filtered_data))
  })
  output$player_info_table <- renderTable({
    req(generate_clicked())
    
    player_info <- data[data$Name == input$player_info, c(
      "Wins.by.Knockout", 
      "Wins.by.Submission", 
      "Wins.by.Decision"
    )]
    
    player_info
  })
    output$player_charts_ui <- renderUI({
    req(generate_clicked())
    
    tabBox(
      title = "",
      id = "player_charts",
      tabPanel("Strike Percentages", 
               plotOutput("strike_percentages_pie")),
      tabPanel("Distribution of strikes by position", 
               plotOutput("placeholder_plot"))
    )
  })
output$player_values_ui <- renderUI({
    req(generate_clicked())
    
    player_values <- data[data$Name == input$player_info, c( 
      "Sig..Str..Defense",
      "Takedown.Defense",
      "Knockdown.Avg",
      "Average.fight.time",
      "Takedown.Accuracy"
    )]
    
    takedown_accuracy <- as.numeric(input$player_values$Takedown.Accuracy)
    player_values$Takedown.Accuracy[is.na(player_values$Takedown.Accuracy)] <- 0
    
    fluidRow(
      valueBox(width = 3,
               paste0(player_values$Knockdown.Avg), "Knockdown avg", icon = icon("skull"),
               color = "orange"
      ),
      valueBox(width = 3,
               paste0(player_values$Average.fight.time, "min"), "Avg fight time", icon = icon("hand-fist"),
               color = "orange"
      ),
      valueBox(width = 3,
               paste0(player_values$Takedown.Defense), "Takedown defense", icon = icon("shield"),
               color = "blue"
      ),
      valueBox(width = 3,
               paste0(player_values$Sig..Str..Defense, "%"), "Sig str defense", 
               color = "blue"
      )
    )
  })
  output$placeholder_plot <- renderPlot({
  req(generate_clicked())  # Wait for the button to be clicked
  
  player_data <- data[data$Name == input$player_info, ]
  columns_of_interest <- c("Sig..Str..By.Position...Standing", 
                           "Sig..Str..By.Position...Clinch", 
                           "Sig..Str..By.Position...Ground")
  pie_data <- player_data[, columns_of_interest]
  
  # Check if any parameter is NA or if all of them are 0
  if (anyNA(pie_data) || all(pie_data == 0)) {
    text <- "No information found about this player"
    plot.new()
    text(0.5, 0.5, text, cex = 1.2, col = "red", font = 2)
  } else {
    percentages <- colSums(pie_data) / sum(colSums(pie_data))
    custom_labels <- paste0(
      c("Standing", "Clinch", "Ground"), 
      ": ", 
      scales::percent(percentages)
    )
    # Create the pie chart
    pie(percentages, labels = custom_labels, main = "Distribution of Strikes by Position")
  }
})
  
output$strike_percentages_pie <- renderPlot({
  req(generate_clicked())  # Only display after clicking "Generate Info" button
  
  player_data <- data[data$Name == input$player_info, ]
  if (nrow(player_data) > 0) {
    strike_percentages <- c(
      player_data$Head...Pourcentage, 
      player_data$Body...Pourcentage, 
      player_data$Leg...Pourcentage
    )
    
    # Check if all percentages are 0
    if (all(strike_percentages == 0)) {
      # Return a message when no info is found
      text <- "No information found about this player"
      plot.new()
      text(0.5, 0.5, text, cex = 1.2, col = "red", font = 2)
    } else {
      custom_labels <- paste0(
        c("Head", "Body", "Leg"), 
        ": ", 
        strike_percentages, "%"
      )
      # Create the pie chart
      pie(strike_percentages, labels = custom_labels, main = "Strike Percentages")
    }
  }
})
observeEvent(input$generate, {
    generate_clicked(TRUE)
  })
}

# Run the Shiny app
shinyApp(ui = ui, server = server)



```
